"use strict";angular.module("nodegraph",[]),angular.module("nodegraph").directive("nodegraph",["$http","$templateCache","$compile",function(e,n,t){return{templateUrl:"template/default.html",restrict:"E",scope:{ngModel:"=?",sbmlUrl:"@?",jsonUrl:"@?",template:"@",linkDistance:"=?",charge:"=?",height:"=?",width:"=?",scale:"=?",force:"=?",nodes:"=?",links:"=?",svg:"=?",species:"=?",reactions:"=?",translate:"=?",runForceLayout:"=?"},link:function(s,i){function o(o){e.get(o,{cache:n}).success(function(e){i.children().remove(),i.append(t(e)(s)),c()})}function r(){s.scale=d3.event.scale,s.translate.x=d3.event.translate[0],s.translate.y=d3.event.translate[1],s.$digest()}function c(){d3.select(i.find("svg")[0]).call(a),s.svg=i}s.jsonUrl&&e.get(s.jsonUrl).success(function(e){s.ngModel=e,s.edges=_.map(e.edges,function(n){return{source:_.find(e.nodes,function(e){return e.id===n[0]}),target:_.find(e.nodes,function(e){return e.id===n[1]})}});var n=e.timeSlots;s.groups=[];var t=0;_.each(n,function(n,i){var o=_.filter(e.nodes,function(e){return _.contains(n,e.id)});_.each(o,function(e){e.group=t});var r=_.filter(s.edges,function(e){return _.contains(n,e.source.id)&&_.contains(n,e.target.id)});s.d3ForceLayout(o,r,{bounds:{w:s.width,h:s.height}}),s.groups.push({nodes:o,links:r,name:i}),t+=1}),o(s.template)}),s.sbmlUrl&&e.get(s.sbmlUrl).success(function(e){var n=new X2JS;s.ngModel=n.xml_str2json(e),s.runForceLayout()}),s.translate={},s.scale=1;var a=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([.5,8]).on("zoom",r);s.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type});var u=function(e){return"object"==typeof e?e.length?e:[e]:"string"==typeof e?e.split():void 0},d=function(e,n){var t={};return angular.forEach(e,function(e){t[e[n||"id"]]=e}),t},l=function(e){var n,t=((e||{}).listOfSpecies||{}).species||{}||[],s=((e||{}).listOfReactions||{}).reaction||{}||[];t=u(t),n=_.map(t,function(e){return{id:e._id,name:e._name,classes:["species"],species:e}});var i;return s=u(s),i=_.map(s,function(e){return{id:e._id,name:e._name,classes:["reaction"],reaction:e}}),n.concat(i)},f=function(e){var n,t=[],i=((e||{}).listOfReactions||{}).reaction||{}||[],o=function(e){var s={reactants:[],products:[],modifiers:[]},i=e.listOfReactants;i&&(n=u(i.speciesReference),_.each(n,function(n){t.push({source:n._species,target:e._id,reaction:e,classes:["reaction","consumption"]}),s.reactants.push(n._species)}));var o=e.listOfProducts;o&&(n=u(o.speciesReference),_.each(n,function(n){t.push({source:e._id,target:n._species,reaction:e,classes:["reaction","production"]}),s.products.push(n._species)}));var r=e.listOfModifiers;return r&&(n=u(r.modifierSpeciesReference),_.each(n,function(n){t.push({source:n._species,target:e._id,reaction:e,classes:["modifier"]}),s.modifiers.push(n._species)})),s},r=u(i);return _.each(r,function(e){var n=o(e);s.reactionInfo[e._id]=n}),t};s.sizeLookup={species:30,reaction:5},s.lookupMarkerId=function(e){return _.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionProduction":_.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionConsumption":void 0},s.textVisibilityLookup={species:!0,reaction:!1},s.color=d3.scale.category20(),s.getReactionPosition=function(e){var n=s.reactionInfo,t=d(s.nodes),i=_.union(n[e].products,n[e].reactants);if(i.length<=1)return t[e];var o=0,r=0;return angular.forEach(i,function(e){o+=t[e].x,r+=t[e].y}),{x:o/i.length,y:r/i.length}},s.extendPoint=function(e,n,t){var s=Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));return{x:n.x+(n.x-e.x)/s*t,y:n.y+(n.y-e.y)/s*t}},s.d3ForceLayout=function(e,n,t){var i=d3.layout.force().charge(s.charge||-700).linkDistance(s.linkDistance||40).size([s.width||800,s.height||800]);return i.nodes(e).links(n).on("tick",function(){s.$digest(),t.bounds&&_.each(e,function(e){e.x=Math.max(s.sizeLookup.species,Math.min(t.bounds.w-s.sizeLookup.species,e.x)),e.y=Math.max(s.sizeLookup.species,Math.min(t.bounds.h-s.sizeLookup.species,e.y))})}).start(),i},s.runForceLayout=function(){if(s.ngModel&&s.ngModel.sbml){s.reactionInfo={},s.nodes=l(s.ngModel.sbml.model),s.edges=f(s.ngModel.sbml.model),s.species=_.filter(s.nodes,function(e){return _.contains(e.classes,"species")}),s.reactions=_.filter(s.nodes,function(e){return _.contains(e.classes,"reaction")});var e={};angular.forEach(s.nodes,function(n,t){e[n.id]=t}),s.links=_.map(s.edges,function(n){return{source:e[n.source],target:e[n.target],reaction:n.reaction,classes:n.classes}}),s.force=d3.layout.force().charge(s.charge||-700).linkDistance(s.linkDistance||40).size([s.width||800,s.height||800]),s.force.nodes(s.nodes).links(s.links).on("tick",function(){s.$digest()}).start(),s.lines=p(s.links,s.nodes)}};var p=function(e,n){var t={production:[],reactant:[],degradation:[],modifier:[]},s={};return _.each(e,function(e){var n=function(e){s[e]=s[e]||{asSource:[],asTarget:[]}};n(e.source.id),n(e.target.id),s[e.source.id].asSource.push(e),s[e.target.id].asTarget.push(e)}),_.each(e,function(e){var i=n[e.source.index],o=n[e.target.index];_.contains(e.classes,"modifier")?t.modifier.push(e):_.contains(i.classes,"reaction")?_.contains(o.classes,"species")&&t.production.push(e):_.contains(i.classes,"species")&&_.contains(o.classes,"reaction")&&(s[o.id].asSource.length>0?t.reactant.push(e):t.degradation.push(e))}),t};s.runForceLayout()}}}]).directive("caseSensitive",function(){return{link:function(e,n,t){e.attr=t;var s=t.caseSensitive.split(",");angular.forEach(s,function(t){var s=t.toLowerCase();e.$watch("attr[lowercase]",function(){n[0].setAttribute(t,n[0].getAttribute(s))})})}}});