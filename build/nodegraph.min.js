"use strict";angular.module("nodegraph",[]),angular.module("nodegraph").directive("nodegraph",["$http",function(e){return{templateUrl:"template/default.html",restrict:"E",scope:{ngModel:"=?",sbmlUrl:"@?",linkDistance:"=?",charge:"=?",height:"=?",width:"=?",scale:"=?",force:"=?",nodes:"=?",links:"=?",svg:"=?",species:"=?",reactions:"=?",translate:"=?",runForceLayout:"=?"},link:function(n,t){function s(){n.scale=d3.event.scale,n.translate.x=d3.event.translate[0],n.translate.y=d3.event.translate[1],n.$digest()}n.sbmlUrl&&e.get(n.sbmlUrl).success(function(e){var t=new X2JS;n.ngModel=t.xml_str2json(e),n.runForceLayout()}),n.translate={},n.scale=1;var r=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([.5,8]).on("zoom",s);d3.select(t.find("svg")[0]).call(r),n.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type}),n.svg=t;var i=function(e){return"object"==typeof e?e.length?e:[e]:"string"==typeof e?e.split():void 0},o=function(e,n){var t={};return angular.forEach(e,function(e){t[e[n||"id"]]=e}),t},c=function(e){var n,t=((e||{}).listOfSpecies||{}).species||{}||[],s=((e||{}).listOfReactions||{}).reaction||{}||[];t=i(t),n=_.map(t,function(e){return{id:e._id,name:e._name,classes:["species"],species:e}});var r;return s=i(s),r=_.map(s,function(e){return{id:e._id,name:e._name,classes:["reaction"],reaction:e}}),n.concat(r)},a=function(e){var t,s=[],r=((e||{}).listOfReactions||{}).reaction||{}||[],o=function(e){var n={reactants:[],products:[],modifiers:[]},r=e.listOfReactants;r&&(t=i(r.speciesReference),_.each(t,function(t){s.push({source:t._species,target:e._id,reaction:e,classes:["reaction","consumption"]}),n.reactants.push(t._species)}));var o=e.listOfProducts;o&&(t=i(o.speciesReference),_.each(t,function(t){s.push({source:e._id,target:t._species,reaction:e,classes:["reaction","production"]}),n.products.push(t._species)}));var c=e.listOfModifiers;return c&&(t=i(c.modifierSpeciesReference),_.each(t,function(t){s.push({source:t._species,target:e._id,reaction:e,classes:["modifier"]}),n.modifiers.push(t._species)})),n},c=i(r);return _.each(c,function(e){var t=o(e);n.reactionInfo[e._id]=t}),s};n.sizeLookup={species:30,reaction:5},n.lookupMarkerId=function(e){return _.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionProduction":_.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionConsumption":void 0},n.textVisibilityLookup={species:!0,reaction:!1},n.color=d3.scale.category20(),n.getReactionPosition=function(e){var t=n.reactionInfo,s=o(n.nodes),r=_.union(t[e].products,t[e].reactants);if(r.length<=1)return s[e];var i=0,c=0;return angular.forEach(r,function(e){i+=s[e].x,c+=s[e].y}),{x:i/r.length,y:c/r.length}},n.extendPoint=function(e,n,t){var s=Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));return{x:n.x+(n.x-e.x)/s*t,y:n.y+(n.y-e.y)/s*t}},n.runForceLayout=function(){if(n.ngModel&&n.ngModel.sbml){n.reactionInfo={},n.nodes=c(n.ngModel.sbml.model),n.edges=a(n.ngModel.sbml.model),n.species=_.filter(n.nodes,function(e){return _.contains(e.classes,"species")}),n.reactions=_.filter(n.nodes,function(e){return _.contains(e.classes,"reaction")});var e={};angular.forEach(n.nodes,function(n,t){e[n.id]=t}),n.links=_.map(n.edges,function(n){return{source:e[n.source],target:e[n.target],reaction:n.reaction,classes:n.classes}}),n.force=d3.layout.force().charge(n.charge||-700).linkDistance(n.linkDistance||40).size([n.width||800,n.height||800]),n.force.nodes(n.nodes).links(n.links).on("tick",function(){n.$digest()}).start(),n.lines=u(n.links,n.nodes)}};var u=function(e,n){var t={production:[],reactant:[],degradation:[],modifier:[]},s={};return _.each(e,function(e){var n=function(e){s[e]=s[e]||{asSource:[],asTarget:[]}};n(e.source.id),n(e.target.id),s[e.source.id].asSource.push(e),s[e.target.id].asTarget.push(e)}),_.each(e,function(e){var r=n[e.source.index],i=n[e.target.index];_.contains(e.classes,"modifier")?t.modifier.push(e):_.contains(r.classes,"reaction")?_.contains(i.classes,"species")&&t.production.push(e):_.contains(r.classes,"species")&&_.contains(i.classes,"reaction")&&(s[i.id].asSource.length>0?t.reactant.push(e):t.degradation.push(e))}),t};n.runForceLayout()}}}]).directive("caseSensitive",function(){return{link:function(e,n,t){e.attr=t;var s=t.caseSensitive.split(",");angular.forEach(s,function(t){var s=t.toLowerCase();e.$watch("attr[lowercase]",function(){n[0].setAttribute(t,n[0].getAttribute(s))})})}}});