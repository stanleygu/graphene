"use strict";angular.module("sg.graphene",["Svgs"]).config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|blob):/)}]);var app=angular.module("Svgs",[]);angular.forEach([{ngAttrName:"ngXlinkHref",attrName:"xlink:href"},{ngAttrName:"ngWidth",attrName:"width"},{ngAttrName:"ngHeight",attrName:"height"}],function(e){var t=e.ngAttrName,n=e.attrName;app.directive(t,function(){return{priority:99,link:function(e,i,o){o.$observe(t,function(e){e&&o.$set(n,e)})}}})}),angular.module("sg.graphene").controller("sgSbmlDataCtrl",["$scope","$http","$window","sgSbml","$log",function(e,t,n,i,o){function r(){e.nodes=i.getNodes(e.ngModel.sbml);var t=i.getEdges(e.ngModel.sbml);e.edges=t.edges,e.reactionInfo=t.reactionInfo,e.species=_.filter(e.nodes,function(e){return _.contains(e.classes,"species")}),e.reactions=_.filter(e.nodes,function(e){return _.contains(e.classes,"reaction")});var r={};angular.forEach(e.nodes,function(t){r[t.id]=t,_.contains(t.classes,"reaction")?(t.width=0,t.height=0,t.rInfo=e.reactionInfo[t.id],t.d=30,t.deg=0,t.getCp1=function(){return{x:this.x+this.d*Math.cos(this.deg/180*Math.PI),y:this.y-this.d*Math.sin(this.deg/180*Math.PI)}},t.getCp2=function(){return{x:this.x+this.d*Math.cos((this.deg+180)/180*Math.PI),y:this.y-this.d*Math.sin((this.deg+180)/180*Math.PI)}},t.reactants=[],_.each(t.rInfo.reactants,function(e){var n=r[e];n||o.error("Could not find reactant node %s",e),t.reactants.push(r[e])}),t.products=[],_.each(t.rInfo.products,function(e){var n=r[e];n||o.error("Could not find product node %s",e),t.products.push(r[e])})):(t.width=e.nodeSize.width,t.height=e.nodeSize.height,t.linksToHere=[],t.linksFromHere=[])}),e.links=_.map(e.edges,function(e){var t=r[e.source],n=r[e.target];t.linksFromHere=t.linksFromHere||[],n.linksToHere=n.linksToHere||[];var i={source:t,target:n,reaction:r[e.rInfo.id],reactionSbml:e.reaction,rInfo:e.rInfo,classes:e.classes};return t.linksFromHere.push(i),n.linksToHere.push(i),i}),_.each(e.species,function(t){for(var n,i=function(n){var i,o,r,s;return"from"===n?(i="linksFromHere",o="linksToHere",r="reactants",s="source"):(i="linksToHere",o="linksFromHere",r="products",s="target"),function(n){var a=_.clone(t);a[i]=[n],a[o]=[],n[s]=a;var c=_.findKey(n.reaction[r],function(e){return e.id===a.id});n.reaction[r][c]=a,e.nodes.push(a),e.species.push(a)}};t.linksFromHere.length>e.max.links.out;)n=_.rest(t.linksFromHere,e.max.links.out),t.linksFromHere=_.first(t.linksFromHere,e.max.links.out),_.each(n,i("from"));for(;t.linksToHere.length>e.max.links.in;)n=_.rest(t.linksToHere),t.linksToHere=_.first(t.linksToHere,e.max.links.in),_.each(n,i("to"))}),e.linkModifiers||(e.links=_.filter(e.links,function(e){return!_.contains(e.classes,"modifier")}));var s=i.getSourceAndSinkNodes(e.nodes,e.links,r);_.each(s.nodes,function(e){e.width=16,e.height=16}),e.nodes=e.nodes.concat(s.nodes),e.links=e.links.concat(s.edges);var a=d3.layout.force().charge(e.charge||-700).linkDistance(e.linkDistance||40).gravity(e.gravity||.1).size([e.width||800,e.height||800]);_.each(e.nodes,function(e){e.force=a});var c=!1;return a.nodes(e.nodes).links(e.links).on("tick",function(){e.height&&e.width&&(_.each(e.nodes,function(t){t.x=Math.max(t.width,Math.min(e.width-t.width,t.x)),t.y=Math.max(t.height,Math.min(e.height-t.height,t.y))}),c||(e.$digest(),c=!0));var t=e.layoutStopThreshold||.01;a.alpha()<=t&&(a.stop(),e.$digest(),e.layoutComplete&&_.isFunction(n[e.layoutComplete])&&n[e.layoutComplete]()),e.$digest()}).start(),e.exports={links:e.links,nodes:e.nodes,reactions:e.reactions,species:e.species,reactionInfo:e.reactionInfo,nodeLookup:r,force:a,height:e.height,width:e.width,allowUnstick:e.allowUnstick,showArcs:e.showArcs,showReactionNodes:e.showReactionNodes,events:d,zoom:!0},a}e.exports={},e.linkModifers=!1,e.allowUnstick=!1,e.showReactionNodes=!1,e.max={links:{"in":1,out:1}};var s={focused:1,unfocused:.1,normal:1},a=function(e){o.info("Clicked on "+e.name)},c=function(e){o.info("Double clicked on "+e.name)},u=function(e,t){if(e.opacity=s.focused,_.contains(e.classes,"species")){_.each(t.imports.species,function(t){t.id!==e.id&&(t.opacity=s.unfocused)}),_.each(t.imports.links,function(e){e.opacity=s.unfocused});var n=[];_.each(_.union(e.linksFromHere,e.linksToHere),function(e){n.push(e.reaction)}),_.each(n,function(e){_.each(_.union(e.products,e.reactants,e.linksFromHere,e.linksToHere),function(e){e.opacity=s.normal})})}},l=function(e,t){_.each(t.imports.nodes,function(e){e.opacity=s.normal}),_.each(t.imports.links,function(e){e.opacity=s.normal})},d={click:a,dblClick:c,mouseover:u,mouseleave:l};e.sbmlUrl&&t.get(e.sbmlUrl).success(function(t){var n=i.sbmlToJson(t);n&&(e.ngModel=n,e.force=r())}),e.$watch("sbml",function(t){if(t){var n=i.sbmlToJson(t);n&&(e.ngModel=n,e.force=r())}}),e.zoom=!0;var h=["charge","linkDistance","gravity"];_.each(h,function(t){e.$watch(t,function(n){n&&e.ngModel&&e.force&&(console.log("Change %s to "+n,t),e.force[t](n).start())})});var g=["linkModifiers","max.links","width","height"];_.each(g,function(t){e.$watch(t,function(t){t&&e.ngModel&&(e.force=r())},!0)})}]),angular.module("sg.graphene").controller("sgSbmlLayoutCtrl",["$scope","sgSbml","sgGeo",function(e,t,n){var i;e.textVisibilityLookup={species:!0,reaction:!1},e.lookupMarkerId=function(e){return _.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionProduction":_.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionConsumption":void 0},e.sizeLookup={species:30,reaction:5};var o=function(e){var t=e.reaction,n=_.union(t.products,t.reactants);if(n.length<=1)return t;var i=0,o=0;return angular.forEach(n,function(e){i+=e.x,o+=e.y}),{x:i/n.length,y:o/n.length}};e.linkArc=function(e){var t=e.x2-e.x1,n=e.y2-e.y1,i=Math.sqrt(t*t+n*n);return"M"+e.x1+","+e.y1+"A"+i+","+i+" 0 0,1 "+e.x2+","+e.y2},e.clickLink=function(t){_.each(e.imports.reactions,function(e){e.selected=!1}),t.reaction.selected=!0},e.clickNode=function(t){_.each(e.imports.reactions,function(e){e.selected=!1}),t.selected=!0},e.extendPoint=function(e,t,n){var i=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));return{x:t.x+(t.x-e.x)/i*n,y:t.y+(t.y-e.y)/i*n}},e.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type});var r=function(t){var i=o(t),r=t.reaction;r.x=i.x,r.y=i.y;var s,a;s=_.isEqual(t.source.width,0)?0:8,a=_.isEqual(t.target.width,0)?0:15;var c=n.getLineIntersectionWithRectangle({x1:t.target.x,y1:t.target.y,x2:t.source.x,y2:t.source.y},{x1:t.source.x-(t.source.width/2+s),y1:t.source.y-(t.source.height/2+s),x2:t.source.x+(t.source.width/2+s),y2:t.source.y+(t.source.height/2+s)}),u=n.getLineIntersectionWithRectangle({x1:t.source.x,y1:t.source.y,x2:t.target.x,y2:t.target.y},{x1:t.target.x-(t.target.width/2+a),y1:t.target.y-(t.target.height/2+a),x2:t.target.x+(t.target.width/2+a),y2:t.target.y+(t.target.height/2+a)});if(_.contains(t.classes,"modifier")){var l=e.extendPoint(c,u,-15);t.x1=c.x,t.y1=c.y,t.x2=l.x,t.y2=l.y,t.cp1=e.extendPoint(u,c,-20),t.cp2=e.extendPoint(c,u,-20)}else t.x1=c.x,t.y1=c.y,t.x2=u.x,t.y2=u.y,t.cp1=e.extendPoint(u,c,-20),t.cp2=e.extendPoint(c,u,-20)},s=function(e){e.centroid={},e.centroid.reactants=_.reduce(e.reactants,function(t,n){var i=t.x+n.x/e.reactants.length,o=t.y+n.y/e.reactants.length;return{x:i,y:o}},{x:0,y:0}),e.centroid.products=_.reduce(e.products,function(t,n){var i=t.x+n.x/e.products.length,o=t.y+n.y/e.products.length;return{x:i,y:o}},{x:0,y:0}),e.deg=180/Math.PI*Math.atan((e.y-e.centroid.reactants.y)/(e.centroid.reactants.x-e.x)),e.centroid.reactants.x<e.x&&(e.deg+=180)},a=[],c=[];e.$watchCollection("imports.links",function(n){n&&(_.each(a,function(e){e()}),a=[],e.links=e.imports.links,i=e.imports.nodeLookup,e.lines=t.classifyLinks(e.links,i),_.each(e.links,function(t){var n=e.$watch(function(){return t.source.x+t.source.y+t.target.x+t.target.y},function(){r(t)});r(t),a.push(n)}))}),e.$watchCollection("imports.nodes",function(t){t&&(_.each(c,function(e){e()}),c=[],e.nodes=e.imports.nodes,e.species=e.imports.species,e.reactions=e.imports.reactions,i=e.imports.nodeLookup,_.each(e.imports.reactions,function(t){var n=e.$watch(function(){var e=0;return _.each(t.reactants,function(t){e+=t.x+t.y}),_.each(t.products,function(t){e+=t.x+t.y}),e},function(){s(t)});c.push(n)}))})}]),angular.module("sg.graphene").controller("sgTidalDataCtrl",["$scope","$http","$window",function(e,t,n){e.callWindowFunction=function(e){_.isFunction(n[e])&&n[e]()},e.$watch("jsonUrl",function(i){i&&t.get(e.jsonUrl).success(function(t){e.data=t,n.copy=angular.copy(t)})}),e.$watch("json",function(t){t&&(e.data=e.json)});var i=function(e){var t=new Blob([e],{type:"text/plain"});return(window.URL||window.webkitURL).createObjectURL(t)};e.svgToUrl=function(){var t=n.document.querySelector("svg"),o=new XMLSerializer;e.svgUrl=i(o.serializeToString(t))},e.$watch("data",function(t){if(t){var n=t;e.edges=_.map(n.edges,function(e){return{source:_.find(n.nodes,function(t){return t.id===e.nodes[0]}),target:_.find(n.nodes,function(t){return t.id===e.nodes[1]}),type:e.type}});var i=n.timeSlots,o=_.keys(i).sort(function(e,t){var n=/[^a-zA-Z]/g,i=/[^0-9]/g,o=e.replace(n,""),r=t.replace(n,"");if(o===r){var s=parseInt(e.replace(i,""),10),a=parseInt(t.replace(i,""),10);return s===a?0:s>a?1:-1}return o>r?1:-1}),r={};r.max=_.max(n.nodes,function(e){return e.size}),r.min=_.min(n.nodes,function(e){return e.size}),e.groups=[];var s=0;_.each(o,function(t){var o=i[t],a=_.filter(n.nodes,function(e){return _.contains(o,e.id)});_.each(a,function(t){t.group=s,t.scaleFactor=(t.size-r.min.size)/(r.max.size-r.min.size),t.width=e.nodeSize.min.width+(e.nodeSize.max.width-e.nodeSize.min.width)*t.scaleFactor,t.height=e.nodeSize.min.height+(e.nodeSize.max.height-e.nodeSize.min.height)*t.scaleFactor});var c=_.filter(e.edges,function(e){return _.contains(o,e.source.id)&&_.contains(o,e.target.id)}),u=d3.layout.force().charge(e.charge||-700).linkDistance(e.linkDistance||40).gravity(e.gravity||.1).size([e.subgraph.width||800,e.subgraph.height||800]);_.each(a,function(e){e.force=u});var l=!1;u.nodes(a).on("tick",function(){e.subgraph.height&&e.subgraph.width&&(_.each(a,function(t){t.x=Math.max(t.width,Math.min(e.subgraph.width-t.width,t.x)),t.y=Math.max(t.height,Math.min(e.subgraph.height-t.height,t.y))}),l||(e.$digest(),l=!0));var t=e.layoutStopThreshold||.01;u.alpha()<=t&&(u.stop(),e.$digest(),e.layoutComplete&&e.callWindowFunction(e.layoutComplete))}).start(),e.groups.push({nodes:a,links:c,name:t}),s+=1}),e.exports={groups:e.groups,edges:e.edges,subgraph:e.subgraph,events:e.events}}})}]),angular.module("sg.graphene").controller("sgTidalLayoutCtrl",["$scope","sgGeo",function(e,t){e.spacer=10;var n=function(n){var i=t.getLineIntersectionWithRectangle({x1:n.source.x,y1:n.source.y+n.source.group*e.imports.subgraph.height,x2:n.target.x,y2:n.target.y+n.target.group*e.imports.subgraph.height},{x1:n.source.x-(n.source.width/2+e.spacer),y1:n.source.y-(n.source.height/2+e.spacer)+n.source.group*e.imports.subgraph.height,x2:n.source.x+n.source.width/2+e.spacer,y2:n.source.y+n.source.height/2+e.spacer+n.source.group*e.imports.subgraph.height}),o=t.getLineIntersectionWithRectangle({x1:n.source.x,y1:n.source.y+n.source.group*e.imports.subgraph.height,x2:n.target.x,y2:n.target.y+n.target.group*e.imports.subgraph.height},{x1:n.target.x-(n.target.width/2+e.spacer),y1:n.target.y-(n.target.height/2+e.spacer)+n.target.group*e.imports.subgraph.height,x2:n.target.x+n.target.width/2+e.spacer,y2:n.target.y+n.target.height/2+e.spacer+n.target.group*e.imports.subgraph.height});n.x1=i.x,n.y1=i.y,n.x2=o.x,n.y2=o.y};e.$watchCollection("imports.edges",function(t){t&&(e.links=e.imports.edges,_.each(e.links,function(t){e.$watch(function(){return t.source.x+t.source.y+t.target.x+t.target.y},function(){n(t)}),n(t)}))}),e.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type}),e.clickNode=function(t,n){var i=e.imports.events.click;_.isFunction(i)&&i(t,e,n)},e.dblClickNode=function(t,n){var i=e.imports.events.dblClick;_.isFunction(i)&&i(t,e,n)},e.mouseoverNode=function(t,n){var i=e.imports.events.mouseover;_.isFunction(i)&&i(t,e,n)},e.mouseleaveNode=function(t,n){var i=e.imports.events.mouseleave;_.isFunction(i)&&i(t,e,n)}}]),angular.module("sg.graphene").directive("sgGraphene",["$http","$templateCache","$compile",function(e,t,n){return{restrict:"E",scope:{template:"@",imports:"=?"},link:function(i,o){function r(r){e.get(r,{cache:t}).success(function(e){o.children().remove(),o.append(n(e)(i)),i.svg=o})}r(i.template),i.$watch("template",function(){r(i.template)})}}}]).directive("zoomable",function(){return{link:function(e,t){function n(){e.imports.zoom&&(e.scale=d3.event.scale,e.translate.x=d3.event.translate[0],e.translate.y=d3.event.translate[1],e.$digest())}e.translate={},e.scale=1;var i=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([.5,8]).on("zoom",n);e.$watch("svg",function(e){e&&d3.select(t[0]).call(i)})}}}).directive("caseSensitive",["$timeout",function(e){return{link:function(t,n,i){e(function(){t.attr=i;var e=i.caseSensitive.split(",");angular.forEach(e,function(e){var i=e.toLowerCase();t.$watch("attr[lowercase]",function(){n[0].setAttribute(e,n[0].getAttribute(i))})})},0)}}}]).directive("draggable",["$document",function(e){return{link:function(t,n){function i(e){var i=n.scope().node;t.imports&&t.imports.force?(i.px=e.pageX/t.scale+r.x,i.py=e.pageY/t.scale+r.y,t.imports.force.resume()):(i.x=e.pageX/t.scale+r.x,i.y=e.pageY/t.scale+r.y),t.onDrag&&t.onDrag(e,i),n.scope().$apply()}function o(){var r=n.scope().node;t.imports.allowUnstick&&r.wasFixed&&delete r.fixed,e.unbind("mousemove",i),e.unbind("mouseup",o),n.scope().$digest()}var r={};n.css({position:"relative",border:"1px solid red",backgroundColor:"lightgrey",cursor:"pointer"}),n.on("mousedown",function(s){s.preventDefault(),s.stopPropagation();var a=n.scope().node;a.wasFixed=a.fixed,a.fixed=!0,r.x=a.x-s.pageX/t.scale,r.y=a.y-s.pageY/t.scale,e.on("mousemove",i),e.on("mouseup",o)})}}}]).filter("truncateTo",function(){return function(e,t){return _.isNumber(t)&&_.size(e)>t?_.first(e,t-3).join("")+"...":e}}).filter("jsonToHtmlTable",function(){return function(e){var t='<table><tr><th>Key</th><th class="pull-right">Value</th></tr><% _.forEach(json, function(value, key) { %><tr><td><%- key %>&nbsp;&nbsp;&nbsp;</td><td class="pull-right"><%- value %></td></tr><% }); %></table>';return _.template(t,{json:e})}}),angular.module("sg.graphene").factory("sgGeo",function(){function e(e,t,n,i,o,r,s,a){var c,u,l,d,h,g={x:null,y:null,onLine1:!1,onLine2:!1};return c=(a-r)*(n-e)-(s-o)*(i-t),0===c?g:(u=t-r,l=e-o,d=(s-o)*u-(a-r)*l,h=(n-e)*u-(i-t)*l,u=d/c,l=h/c,g.x=e+u*(n-e),g.y=t+u*(i-t),u>0&&1>u&&(g.onLine1=!0),l>0&&1>l&&(g.onLine2=!0),g)}var t=function(t,n){var i,o=[{x1:n.x1,y1:n.y1,x2:n.x1,y2:n.y2},{x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y1},{x1:n.x2,y1:n.y1,x2:n.x2,y2:n.y2},{x1:n.x1,y1:n.y2,x2:n.x2,y2:n.y2}];return _.each(o,function(n){if(!i){var o=e(t.x1,t.y1,t.x2,t.y2,n.x1,n.y1,n.x2,n.y2);o.onLine1&&o.onLine2&&(i=o)}}),i||(i={x:(n.x1+n.x2)/2,y:(n.y1+n.y2)/2}),i};return{getLineIntersectionWithRectangle:t}}),angular.module("sg.graphene").factory("sgSbml",function(){function e(e){var t,i=((e||{}).listOfSpecies||{}).species||{}||[],o=((e||{}).listOfReactions||{}).reaction||{}||[];i=n(i),t=_.map(i,function(e){return{id:e._id,name:e._name,classes:["species"],species:e}});var r;o=n(o),r=_.map(o,function(e){return{id:e._id,name:e._name,classes:["reaction"],reaction:e}});var s=[];return s.concat(t,r)}function t(e){var t,i=[],o=((e||{}).listOfReactions||{}).reaction||{}||[],r=function(e){var o={id:e._id,reactants:[],products:[],modifiers:[]},r=e.listOfReactants;r&&(t=n(r.speciesReference),_.each(t,function(t){i.push({source:t._species,target:e._id,reaction:e,rInfo:o,classes:["reaction","consumption"]}),o.reactants.push(t._species)}));var s=e.listOfProducts;s&&(t=n(s.speciesReference),_.each(t,function(t){i.push({source:e._id,target:t._species,reaction:e,rInfo:o,classes:["reaction","production"]}),o.products.push(t._species)}));var a=e.listOfModifiers;return a&&(t=n(a.modifierSpeciesReference),_.each(t,function(t){i.push({source:t._species,target:e._id,reaction:e,rInfo:o,classes:["modifier"]}),o.modifiers.push(t._species)})),o},s=n(o),a={};return _.each(s,function(e){var t=r(e);a[e._id]=t}),{edges:i,reactionInfo:a}}function n(e){return"object"==typeof e?e.length?e:[e]:"string"==typeof e?e.split():void 0}function i(e,t){var n={production:[],generation:[],reactant:[],degradation:[],modifier:[],source:[],sink:[]},i={};return _.each(e,function(e){var t=function(e){i[e]=i[e]||{asSource:[],asTarget:[]}};_.contains(e.classes,"modifier")||(t(e.source.id),t(e.target.id),i[e.source.id].asSource.push(e),i[e.target.id].asTarget.push(e))}),_.each(e,function(e){var o=e.source,r=e.target;if(_.contains(e.classes,"modifier"))n.modifier.push(e);else if(_.contains(e.classes,"sink"))n.sink.push(e);else if(_.contains(e.classes,"source"))n.source.push(e);else if(_.contains(o.classes,"reaction"))_.contains(r.classes,"species")&&(i[o.id].asTarget.length>0?(n.production.push(e),e.classes=_.union(e.classes,["production"]),o.rInfo.products.length>1&&_.each(o.rInfo.products,function(n){if(n!==r.id){e.siblings=e.siblings||[];var i=t[n];e.siblings=_.union(e.siblings,i)}})):(n.generation.push(e),e.classes=_.union(e.classes,["generation"])));else{if(!_.contains(o.classes,"species"))throw new Error("Could not classify link",e);_.contains(r.classes,"reaction")&&(i[r.id].asSource.length>0?(n.reactant.push(e),e.classes=_.union(e.classes,["reactant"]),r.rInfo.reactants.length>1&&_.each(r.rInfo.reactants,function(n){if(n!==r.id){e.siblings=e.siblings||[];var i=t[n];e.siblings=_.union(e.siblings,i)}})):(n.degradation.push(e),e.classes=_.union(e.classes,["degradation"])))}}),n}function o(e,t,n){var o=[],r=[],s=i(t,n);return _.each(s.generation,function(e){var t=e.source,n={id:"source-"+t.id,name:"Source",classes:["source"],reaction:t};o.push(n),e.rInfo.reactants.push(n.id),r.push({source:n,target:e.source,rInfo:e.rInfo,classes:["source"],reaction:e.reaction})}),_.each(s.degradation,function(e){var t=e.target,n={id:"sink-"+t.id,name:"Sink",classes:["sink"],reaction:t};o.push(n),e.rInfo.products.push(n.id),r.push({source:e.target,target:n,rInfo:e.rInfo,classes:["sink"],reaction:e.reaction})}),{nodes:o,edges:r}}var r=new X2JS;return{getSourceAndSinkNodes:function(e,t,n){return o(e,t,n)},getNodes:function(t){return e(t.model)},getEdges:function(e){return t(e.model)},classifyLinks:function(e,t){return i(e,t)},sbmlToJson:function(e){var t=r.xml_str2json(e);return t&&t.sbml&&t.sbml.model?t:!1}}});