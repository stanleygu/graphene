"use strict";angular.module("sg.graphene",[]).config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|blob):/)}]),angular.module("sg.graphene").controller("sgSbmlDataCtrl",["$scope","$http",function(e,n){function t(){e.reactionInfo={},e.nodes=o(e.ngModel.sbml.model),e.edges=i(e.ngModel.sbml.model),e.species=_.filter(e.nodes,function(e){return _.contains(e.classes,"species")}),e.reactions=_.filter(e.nodes,function(e){return _.contains(e.classes,"reaction")});var n={};angular.forEach(e.nodes,function(e){n[e.id]=e}),e.links=_.map(e.edges,function(e){return{source:n[e.source],target:n[e.target],reaction:e.reaction,rInfo:e.rInfo,classes:e.classes}})}function o(e){var n,t=((e||{}).listOfSpecies||{}).species||{}||[],o=((e||{}).listOfReactions||{}).reaction||{}||[];t=a(t),n=_.map(t,function(e){return{id:e._id,name:e._name,classes:["species"],species:e}});var i;return o=a(o),i=_.map(o,function(e){return{id:e._id,name:e._name,classes:["reaction"],reaction:e}}),n.concat(i)}function i(n){var t=[];e.reactionInfo={};var o,i=((n||{}).listOfReactions||{}).reaction||{}||[],r=function(e){var n={id:e._id,reactants:[],products:[],modifiers:[]},i=e.listOfReactants;i&&(o=a(i.speciesReference),_.each(o,function(o){t.push({source:o._species,target:e._id,reaction:e,rInfo:n,classes:["reaction","consumption"]}),n.reactants.push(o._species)}));var r=e.listOfProducts;r&&(o=a(r.speciesReference),_.each(o,function(o){t.push({source:e._id,target:o._species,reaction:e,rInfo:n,classes:["reaction","production"]}),n.products.push(o._species)}));var s=e.listOfModifiers;return s&&(o=a(s.modifierSpeciesReference),_.each(o,function(o){t.push({source:o._species,target:e._id,reaction:e,rInfo:n,classes:["modifier"]}),n.modifiers.push(o._species)})),n},s=a(i);return _.each(s,function(n){var t=r(n);e.reactionInfo[n._id]=t}),t}function a(e){return"object"==typeof e?e.length?e:[e]:"string"==typeof e?e.split():void 0}e.sbmlUrl&&n.get(e.sbmlUrl).success(function(n){var o=new X2JS;e.ngModel=o.xml_str2json(n),t()}),e.$watch("sbml",function(n){if(n){var o=new X2JS;e.ngModel=o.xml_str2json(n),t()}})}]),angular.module("sg.graphene").controller("sgSbmlLayoutCtrl",["$scope",function(e){function n(e,n,t,o,i,a,r,s){var c,u,l,d,f,p={x:null,y:null,onLine1:!1,onLine2:!1};return c=(s-a)*(t-e)-(r-i)*(o-n),0===c?p:(u=n-a,l=e-i,d=(r-i)*u-(s-a)*l,f=(t-e)*u-(o-n)*l,u=d/c,l=f/c,p.x=e+u*(t-e),p.y=n+u*(o-n),u>0&&1>u&&(p.onLine1=!0),l>0&&1>l&&(p.onLine2=!0),p)}e.nodeSize={width:100,height:30},e.spacer=18,e.classifyLinks=function(e){var n={production:[],reactant:[],degradation:[],modifier:[]},t={};return _.each(e,function(e){var n=function(e){t[e]=t[e]||{asSource:[],asTarget:[]}};n(e.source.id),n(e.target.id),t[e.source.id].asSource.push(e),t[e.target.id].asTarget.push(e)}),_.each(e,function(e){var o=e.source,i=e.target;_.contains(e.classes,"modifier")?n.modifier.push(e):_.contains(o.classes,"reaction")?_.contains(i.classes,"species")&&n.production.push(e):_.contains(o.classes,"species")&&_.contains(i.classes,"reaction")&&(t[i.id].asSource.length>0?n.reactant.push(e):n.degradation.push(e))}),n};var t=_.memoize(function(e,n){var t={};return angular.forEach(e,function(e){t[e[n||"id"]]=e}),t});e.textVisibilityLookup={species:!0,reaction:!1},e.lookupMarkerId=function(e){return _.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionProduction":_.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionConsumption":void 0},e.sizeLookup={species:30,reaction:5},e.getReactionPosition=function(n){var o=n.rInfo,i=t(e.nodes),a=_.union(o.products,o.reactants);if(a.length<=1)return i[o.id];var r=0,s=0;return angular.forEach(a,function(e){r+=i[e].x,s+=i[e].y}),{x:r/a.length,y:s/a.length}},e.getLineIntersectionWithRectangle=function(e,t){var o,i=[{x1:t.x1,y1:t.y1,x2:t.x1,y2:t.y2},{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y1},{x1:t.x2,y1:t.y1,x2:t.x2,y2:t.y2},{x1:t.x1,y1:t.y2,x2:t.x2,y2:t.y2}];return _.each(i,function(t){if(!o){var i=n(e.x1,e.y1,e.x2,e.y2,t.x1,t.y1,t.x2,t.y2);i.onLine1&&i.onLine2&&(o=i)}}),o||(o={x:(t.x1+t.x2)/2,y:(t.y1+t.y2)/2}),o},e.$watchCollection("links",function(n){n&&(e.lines=e.classifyLinks(e.links))}),e.$watchCollection("nodes",function(n){n&&(e.species=_.filter(e.nodes,function(e){return _.contains(e.classes,"species")}),e.reactions=_.filter(e.nodes,function(e){return _.contains(e.classes,"reaction")}))})}]),angular.module("sg.graphene").controller("sgTidalDataCtrl",["$scope","$http",function(e,n){e.jsonUrl?n.get(e.jsonUrl).success(function(n){e.data=n}):e.json&&(e.data=e.json);var t=function(e){var n=new Blob([e],{type:"text/plain"});return(window.URL||window.webkitURL).createObjectURL(n)};e.svgToUrl=function(){var n=e.svg.find("svg")[0],o=new XMLSerializer;e.svgUrl=t(o.serializeToString(n))};var o=e.$watch("forceLayout",function(n){if(n){var t=e.$watch("data",function(n){if(n){var o=n;e.edges=_.map(o.edges,function(e){return{source:_.find(o.nodes,function(n){return n.id===e.nodes[0]}),target:_.find(o.nodes,function(n){return n.id===e.nodes[1]}),type:e.type}});var i=o.timeSlots,a=_.keys(i).sort(function(e,n){var t=/[^a-zA-Z]/g,o=/[^0-9]/g,i=e.replace(t,""),a=n.replace(t,"");if(i===a){var r=parseInt(e.replace(o,""),10),s=parseInt(n.replace(o,""),10);return r===s?0:r>s?1:-1}return i>a?1:-1});e.groups=[];var r=0;_.each(a,function(n){var t=i[n],a=_.filter(o.nodes,function(e){return _.contains(t,e.id)});_.each(a,function(e){e.group=r});var s=_.filter(e.edges,function(e){return _.contains(t,e.source.id)&&_.contains(t,e.target.id)});e.forceLayout(a,[]),e.groups.push({nodes:a,links:s,name:n}),r+=1}),e.additionalData={groups:e.groups,edges:e.edges},t()}});o()}})}]),angular.module("sg.graphene").controller("sgTidalLayoutCtrl",["$scope",function(e){function n(e,n,t,o,i,a,r,s){var c,u,l,d,f,p={x:null,y:null,onLine1:!1,onLine2:!1};return c=(s-a)*(t-e)-(r-i)*(o-n),0===c?p:(u=n-a,l=e-i,d=(r-i)*u-(s-a)*l,f=(t-e)*u-(o-n)*l,u=d/c,l=f/c,p.x=e+u*(t-e),p.y=n+u*(o-n),u>0&&1>u&&(p.onLine1=!0),l>0&&1>l&&(p.onLine2=!0),p)}e.aspectRatio=3,e.scaleFactor=.1,e.spacer=10,e.getLineIntersectionWithRectangle=function(e,t){var o,i=[{x1:t.x1,y1:t.y1,x2:t.x1,y2:t.y2},{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y1},{x1:t.x2,y1:t.y1,x2:t.x2,y2:t.y2},{x1:t.x1,y1:t.y2,x2:t.x2,y2:t.y2}];return _.each(i,function(t){if(!o){var i=n(e.x1,e.y1,e.x2,e.y2,t.x1,t.y1,t.x2,t.y2);i.onLine1&&i.onLine2&&(o=i)}}),o||(o={x:(t.x1+t.x2)/2,y:(t.y1+t.y2)/2}),o},e.OPACITY={focused:1,unfocused:.1,normal:.6},e.mouseoverNode=function(n){n.opacity=e.OPACITY.focused,_.each(e.additionalData.groups,function(t){_.each(t.nodes,function(t){t.id!==n.id&&(t.opacity=e.OPACITY.unfocused)})}),_.each(e.additionalData.edges,function(t){t.source.id!==n.id&&t.target.id!==n.id?t.opacity=e.OPACITY.unfocused:(t.opacity=e.OPACITY.focused,t.target.opacity=e.OPACITY.focused,t.source.opacity=e.OPACITY.focused)})},e.mouseleaveNode=function(){_.each(e.additionalData.groups,function(e){_.each(e.nodes,function(e){e.opacity=1})}),_.each(e.additionalData.edges,function(n){n.opacity=e.OPACITY.normal})}}]),angular.module("sg.graphene").directive("sgGraphene",["$http","$templateCache","$compile","$window",function(e,n,t,o){return{restrict:"E",scope:{ngModel:"=?",sbml:"=?",sbmlUrl:"@?",jsonUrl:"@?",template:"@",nodes:"=?",links:"=?",params:"=?",linkDistance:"=?",charge:"=?",gravity:"=?",height:"=?",width:"=?",nodeSize:"=?",scale:"=?",force:"=?",svg:"=?",translate:"=?",layoutComplete:"=?",layoutStopThreshold:"=?",forceLayout:"=?",additionalData:"=?"},link:function(i,a){function r(o){e.get(o,{cache:n}).success(function(e){a.children().remove(),a.append(t(e)(i)),c()})}function s(){i.scale=d3.event.scale,i.translate.x=d3.event.translate[0],i.translate.y=d3.event.translate[1],i.$digest()}function c(){i.svg=a}r(i.template),_&&(i._=_);var u=["links","nodes"];_.each(u,function(e){i.$watchCollection(e,function(e){e&&i.forceLayout(i.nodes,i.links,i.params)})}),i.translate={},i.scale=1;var l=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([.5,8]).on("zoom",s);i.$watch("enable-zoom",function(e){e&&d3.select(a.find("svg")[0]).call(l)}),i.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type}),i.extendPoint=function(e,n,t){var o=Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));return{x:n.x+(n.x-e.x)/o*t,y:n.y+(n.y-e.y)/o*t}},i.forceLayout=function(e,n){var t=d3.layout.force().charge(i.charge||-700).linkDistance(i.linkDistance||40).gravity(i.gravity||.1).size([i.width||800,i.height||800]);_.each(e,function(e){e.force=t});var a=!1;return t.nodes(e).links(n).on("tick",function(){i.height&&i.width&&i.nodeSize&&(_.each(e,function(e){e.x=Math.max(i.nodeSize.width,Math.min(i.width-i.nodeSize.width,e.x)),e.y=Math.max(i.nodeSize.height,Math.min(i.height-i.nodeSize.height,e.y))}),a||(i.$digest(),a=!0));var n=i.layoutStopThreshold||.01;t.alpha()<=n&&(t.stop(),i.$digest(),i.layoutComplete&&_.isFunction(o[i.layoutComplete])&&o[i.layoutComplete]())}).start(),t}}}}]).directive("caseSensitive",function(){return{link:function(e,n,t){e.attr=t;var o=t.caseSensitive.split(",");angular.forEach(o,function(t){var o=t.toLowerCase();e.$watch("attr[lowercase]",function(){n[0].setAttribute(t,n[0].getAttribute(o))})})}}}).directive("draggable",["$document",function(e){return{link:function(n,t){function o(e){var o=t.scope().node;o.x=e.pageX/n.scale+a.x,o.y=e.pageY/n.scale+a.y,t.scope().$apply(),n.onDrag&&n.onDrag(e,o)}function i(){e.unbind("mousemove",o),e.unbind("mouseup",i)}var a={};t.css({position:"relative",border:"1px solid red",backgroundColor:"lightgrey",cursor:"pointer"}),t.on("mousedown",function(r){r.preventDefault(),r.stopPropagation(),a.x=t.scope().node.x-r.pageX/n.scale,a.y=t.scope().node.y-r.pageY/n.scale,e.on("mousemove",o),e.on("mouseup",i)})}}}]);