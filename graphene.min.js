"use strict";angular.module("sg.graphene",[]).config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|blob):/)}]),angular.module("sg.graphene").controller("sgSbmlDataCtrl",["$scope","$http","$window","sgSbml",function(e,n,t,o){function i(){e.nodes=o.getNodes(e.ngModel.sbml);var n=o.getEdges(e.ngModel.sbml);e.edges=n.edges,e.reactionInfo=n.reactionInfo,e.species=_.filter(e.nodes,function(e){return _.contains(e.classes,"species")}),e.reactions=_.filter(e.nodes,function(e){return _.contains(e.classes,"reaction")});var i={};angular.forEach(e.nodes,function(n){i[n.id]=n,_.contains(n.classes,"reaction")?(n.width=0,n.height=0,n.rInfo=e.reactionInfo[n.id]):(n.width=e.nodeSize.width,n.height=e.nodeSize.height)}),e.links=_.map(e.edges,function(e){return{source:i[e.source],target:i[e.target],reaction:e.reaction,rInfo:e.rInfo,classes:e.classes}}),e.linkModifiers||(e.links=_.filter(e.links,function(e){return!_.contains(e.classes,"modifier")}));var s=o.getSourceAndSinkNodes(e.nodes,e.links);_.each(s.nodes,function(e){e.width=16,e.height=16}),e.nodes=e.nodes.concat(s.nodes),e.links=e.links.concat(s.edges),e.sourceNodes=_.filter(e.nodes,function(e){return _.contains(e.classes,"source")}),e.sinkNodes=_.filter(e.nodes,function(e){return _.contains(e.classes,"sink")});var r=d3.layout.force().charge(e.charge||-700).linkDistance(e.linkDistance||40).gravity(e.gravity||.1).size([e.width||800,e.height||800]);_.each(e.nodes,function(e){e.force=r});var a=!1;return r.nodes(e.nodes).links(e.links).on("tick",function(){e.height&&e.width&&(_.each(e.nodes,function(n){n.x=Math.max(n.width,Math.min(e.width-n.width,n.x)),n.y=Math.max(n.height,Math.min(e.height-n.height,n.y))}),a||(e.$digest(),a=!0));var n=e.layoutStopThreshold||.01;r.alpha()<=n&&(r.stop(),e.$digest(),e.layoutComplete&&_.isFunction(t[e.layoutComplete])&&t[e.layoutComplete]()),e.$digest()}).start(),e.exports={links:e.links,nodes:e.nodes,reactions:e.reactions,species:e.species,reactionInfo:e.reactionInfo,nodeLookup:i,force:r,height:e.height,width:e.width,allowUnstick:e.allowUnstick,showArcs:e.showArcs,showReactionNodes:e.showReactionNodes,events:l,zoom:!0},r}e.exports={},e.linkModifers=!1,e.allowUnstick=!0,e.showReactionNodes=!1;var s={focused:1,unfocused:.1,normal:1},r=function(e){console.log("Clicked on "+e.name)},a=function(e){console.log("Double clicked on "+e.name)},c=function(e,n,t){var o=t.target;if(console.log("mousing over",o),e.opacity=s.focused,_.contains(e.classes,"species")){_.each(n.imports.nodes,function(n){n.id!==e.id&&(n.opacity=s.unfocused)});var i=[];_.each(n.imports.reactionInfo,function(t){if(_.contains(t.products,e.id)||_.contains(t.reactants,e.id)){i.push(t);var o=t.reactants.concat(t.products);_.each(o,function(e){n.imports.nodeLookup[e].opacity=s.normal})}}),_.each(n.imports.links,function(e){e.opacity=_.contains(_.map(i,"id"),e.rInfo.id)?s.focused:s.unfocused})}},u=function(e,n){_.each(n.imports.nodes,function(e){e.opacity=s.normal}),_.each(n.imports.links,function(e){e.opacity=s.normal})},l={click:r,dblClick:a,mouseover:c,mouseleave:u};e.sbmlUrl&&n.get(e.sbmlUrl).success(function(n){var t=o.sbmlToJson(n);t&&(e.ngModel=t,e.force=i())}),e.$watch("sbml",function(n){if(n){var t=o.sbmlToJson(n);t&&(e.ngModel=t,e.force=i())}}),e.zoom=!0;var d=["charge","linkDistance","gravity"];_.each(d,function(n){e.$watch(n,function(t){t&&e.force&&(console.log("Change %s to "+t,n),e.force[n](t).start())})}),e.$watch("linkModifiers",function(n){_.isUndefined(n)||(e.force=i())})}]),angular.module("sg.graphene").controller("sgSbmlLayoutCtrl",["$scope","sgSbml",function(e,n){function t(e,n,t,o,i,s,r,a){var c,u,l,d,g,h={x:null,y:null,onLine1:!1,onLine2:!1};return c=(a-s)*(t-e)-(r-i)*(o-n),0===c?h:(u=n-s,l=e-i,d=(r-i)*u-(a-s)*l,g=(t-e)*u-(o-n)*l,u=d/c,l=g/c,h.x=e+u*(t-e),h.y=n+u*(o-n),u>0&&1>u&&(h.onLine1=!0),l>0&&1>l&&(h.onLine2=!0),h)}var o;e.textVisibilityLookup={species:!0,reaction:!1},e.lookupMarkerId=function(e){return _.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionProduction":_.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionConsumption":void 0},e.sizeLookup={species:30,reaction:5};var i=function(e){var n=e.rInfo;return o[n.id]},s=function(e){var n=e.rInfo,t=i(e),s=_.union(n.products,n.reactants);if(s.length<=1)return t;var r=0,a=0;return angular.forEach(s,function(e){var n=o[e];r+=n.x,a+=n.y}),{x:r/s.length,y:a/s.length}},r=function(e,n){var o,i=[{x1:n.x1,y1:n.y1,x2:n.x1,y2:n.y2},{x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y1},{x1:n.x2,y1:n.y1,x2:n.x2,y2:n.y2},{x1:n.x1,y1:n.y2,x2:n.x2,y2:n.y2}];return _.each(i,function(n){if(!o){var i=t(e.x1,e.y1,e.x2,e.y2,n.x1,n.y1,n.x2,n.y2);i.onLine1&&i.onLine2&&(o=i)}}),o||(o={x:(n.x1+n.x2)/2,y:(n.y1+n.y2)/2}),o};e.linkArc=function(e){var n=e.x2-e.x1,t=e.y2-e.y1,o=Math.sqrt(n*n+t*t);return"M"+e.x1+","+e.y1+"A"+o+","+o+" 0 0,1 "+e.x2+","+e.y2},e.extendPoint=function(e,n,t){var o=Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));return{x:n.x+(n.x-e.x)/o*t,y:n.y+(n.y-e.y)/o*t}},e.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type});var a=function(n){var t=s(n),o=i(n);o.x=t.x,o.y=t.y;var a,c;a=_.isEqual(n.source.width,0)?0:8,c=_.isEqual(n.target.width,0)?0:15;var u=r({x1:n.target.x,y1:n.target.y,x2:n.source.x,y2:n.source.y},{x1:n.source.x-(n.source.width/2+a),y1:n.source.y-(n.source.height/2+a),x2:n.source.x+(n.source.width/2+a),y2:n.source.y+(n.source.height/2+a)}),l=r({x1:n.source.x,y1:n.source.y,x2:n.target.x,y2:n.target.y},{x1:n.target.x-(n.target.width/2+c),y1:n.target.y-(n.target.height/2+c),x2:n.target.x+(n.target.width/2+c),y2:n.target.y+(n.target.height/2+c)});if(_.contains(n.classes,"modifier")){var d=e.extendPoint(u,l,-15);n.x1=u.x,n.y1=u.y,n.x2=d.x,n.y2=d.y}else n.x1=u.x,n.y1=u.y,n.x2=l.x,n.y2=l.y},c=[],u=[];e.$watchCollection("imports.links",function(t){t&&(_.each(c,function(e){e()}),c=[],e.links=e.imports.links,e.lines=n.classifyLinks(e.links),o=e.imports.nodeLookup,_.each(e.links,function(n){var t=e.$watch(function(){return n.source.x+n.source.y+n.target.x+n.target.y},function(){a(n)});a(n),c.push(t)}))}),e.$watchCollection("imports.nodes",function(n){n&&(_.each(u,function(e){e()}),u=[],e.nodes=e.imports.nodes,e.species=e.imports.species,e.reactions=e.imports.reactions,o=e.imports.nodeLookup)})}]),angular.module("sg.graphene").controller("sgTidalDataCtrl",["$scope","$http","$window",function(e,n,t){e.callWindowFunction=function(e){_.isFunction(t[e])&&t[e]()},e.$watch("jsonUrl",function(o){o&&n.get(e.jsonUrl).success(function(n){e.data=n,t.copy=angular.copy(n)})}),e.$watch("json",function(n){n&&(e.data=e.json)});var o=function(e){var n=new Blob([e],{type:"text/plain"});return(window.URL||window.webkitURL).createObjectURL(n)};e.svgToUrl=function(){var n=t.document.querySelector("svg"),i=new XMLSerializer;e.svgUrl=o(i.serializeToString(n))},e.$watch("data",function(n){if(n){var t=n;e.edges=_.map(t.edges,function(e){return{source:_.find(t.nodes,function(n){return n.id===e.nodes[0]}),target:_.find(t.nodes,function(n){return n.id===e.nodes[1]}),type:e.type}});var o=t.timeSlots,i=_.keys(o).sort(function(e,n){var t=/[^a-zA-Z]/g,o=/[^0-9]/g,i=e.replace(t,""),s=n.replace(t,"");if(i===s){var r=parseInt(e.replace(o,""),10),a=parseInt(n.replace(o,""),10);return r===a?0:r>a?1:-1}return i>s?1:-1}),s={};s.max=_.max(t.nodes,function(e){return e.size}),s.min=_.min(t.nodes,function(e){return e.size}),e.groups=[];var r=0;_.each(i,function(n){var i=o[n],a=_.filter(t.nodes,function(e){return _.contains(i,e.id)});_.each(a,function(n){n.group=r,n.scaleFactor=(n.size-s.min.size)/(s.max.size-s.min.size),n.width=e.nodeSize.min.width+(e.nodeSize.max.width-e.nodeSize.min.width)*n.scaleFactor,n.height=e.nodeSize.min.height+(e.nodeSize.max.height-e.nodeSize.min.height)*n.scaleFactor});var c=_.filter(e.edges,function(e){return _.contains(i,e.source.id)&&_.contains(i,e.target.id)}),u=d3.layout.force().charge(e.charge||-700).linkDistance(e.linkDistance||40).gravity(e.gravity||.1).size([e.subgraph.width||800,e.subgraph.height||800]);_.each(a,function(e){e.force=u});var l=!1;u.nodes(a).on("tick",function(){e.subgraph.height&&e.subgraph.width&&(_.each(a,function(n){n.x=Math.max(n.width,Math.min(e.subgraph.width-n.width,n.x)),n.y=Math.max(n.height,Math.min(e.subgraph.height-n.height,n.y))}),l||(e.$digest(),l=!0));var n=e.layoutStopThreshold||.01;u.alpha()<=n&&(u.stop(),e.$digest(),e.layoutComplete&&e.callWindowFunction(e.layoutComplete))}).start(),e.groups.push({nodes:a,links:c,name:n}),r+=1}),e.exports={groups:e.groups,edges:e.edges,subgraph:e.subgraph,events:e.events}}})}]),angular.module("sg.graphene").controller("sgTidalLayoutCtrl",["$scope","sgGeo",function(e,n){e.spacer=10;var t=function(t){var o=n.getLineIntersectionWithRectangle({x1:t.source.x,y1:t.source.y+t.source.group*e.imports.subgraph.height,x2:t.target.x,y2:t.target.y+t.target.group*e.imports.subgraph.height},{x1:t.source.x-(t.source.width/2+e.spacer),y1:t.source.y-(t.source.height/2+e.spacer)+t.source.group*e.imports.subgraph.height,x2:t.source.x+t.source.width/2+e.spacer,y2:t.source.y+t.source.height/2+e.spacer+t.source.group*e.imports.subgraph.height}),i=n.getLineIntersectionWithRectangle({x1:t.source.x,y1:t.source.y+t.source.group*e.imports.subgraph.height,x2:t.target.x,y2:t.target.y+t.target.group*e.imports.subgraph.height},{x1:t.target.x-(t.target.width/2+e.spacer),y1:t.target.y-(t.target.height/2+e.spacer)+t.target.group*e.imports.subgraph.height,x2:t.target.x+t.target.width/2+e.spacer,y2:t.target.y+t.target.height/2+e.spacer+t.target.group*e.imports.subgraph.height});t.x1=o.x,t.y1=o.y,t.x2=i.x,t.y2=i.y};e.$watchCollection("imports.edges",function(n){n&&(e.links=e.imports.edges,_.each(e.links,function(n){e.$watch(function(){return n.source.x+n.source.y+n.target.x+n.target.y},function(){t(n)}),t(n)}))}),e.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type}),e.clickNode=function(n,t){var o=e.imports.events.click;_.isFunction(o)&&o(n,e,t)},e.dblClickNode=function(n,t){var o=e.imports.events.dblClick;_.isFunction(o)&&o(n,e,t)},e.mouseoverNode=function(n,t){var o=e.imports.events.mouseover;_.isFunction(o)&&o(n,e,t)},e.mouseleaveNode=function(n,t){var o=e.imports.events.mouseleave;_.isFunction(o)&&o(n,e,t)}}]),angular.module("sg.graphene").directive("sgGraphene",["$http","$templateCache","$compile","$log",function(e,n,t,o){return{restrict:"E",scope:{template:"@",imports:"=?"},link:function(i,s){function r(o){e.get(o,{cache:n}).success(function(e){s.children().remove(),s.append(t(e)(i)),c()})}function a(){i.imports.zoom&&(i.scale=d3.event.scale,i.translate.x=d3.event.translate[0],i.translate.y=d3.event.translate[1],i.$digest())}function c(){i.svg=s}r(i.template),i.translate={},i.scale=1;var u=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([.5,8]).on("zoom",a);i.$watch("svg",function(e){e&&(o.info(s.find("svg")),d3.select(s.find("svg")[0]).call(u))})}}}]).directive("caseSensitive",["$timeout",function(e){return{link:function(n,t,o){e(function(){n.attr=o;var e=o.caseSensitive.split(",");angular.forEach(e,function(e){var o=e.toLowerCase();n.$watch("attr[lowercase]",function(){t[0].setAttribute(e,t[0].getAttribute(o))})})},0)}}}]).directive("draggable",["$document",function(e){return{link:function(n,t){function o(e){var o=t.scope().node;n.imports&&n.imports.force?(o.px=e.pageX/n.scale+s.x,o.py=e.pageY/n.scale+s.y,n.imports.force.resume()):(o.x=e.pageX/n.scale+s.x,o.y=e.pageY/n.scale+s.y),n.onDrag&&n.onDrag(e,o),t.scope().$apply()}function i(){var s=t.scope().node;n.imports.allowUnstick&&s.wasFixed&&delete s.fixed,e.unbind("mousemove",o),e.unbind("mouseup",i),t.scope().$digest()}var s={};t.css({position:"relative",border:"1px solid red",backgroundColor:"lightgrey",cursor:"pointer"}),t.on("mousedown",function(r){r.preventDefault(),r.stopPropagation();var a=t.scope().node;a.wasFixed=a.fixed,a.fixed=!0,s.x=a.x-r.pageX/n.scale,s.y=a.y-r.pageY/n.scale,e.on("mousemove",o),e.on("mouseup",i)})}}}]).filter("truncateTo",function(){return function(e,n){return _.isNumber(n)&&_.size(e)>n?_.first(e,n-3).join("")+"...":e}}).filter("jsonToHtmlTable",function(){return function(e){var n='<table><tr><th>Key</th><th class="pull-right">Value</th></tr><% _.forEach(json, function(value, key) { %><tr><td><%- key %>&nbsp;&nbsp;&nbsp;</td><td class="pull-right"><%- value %></td></tr><% }); %></table>';return _.template(n,{json:e})}}),angular.module("sg.graphene").factory("sgGeo",function(){function e(e,n,t,o,i,s,r,a){var c,u,l,d,g,h={x:null,y:null,onLine1:!1,onLine2:!1};return c=(a-s)*(t-e)-(r-i)*(o-n),0===c?h:(u=n-s,l=e-i,d=(r-i)*u-(a-s)*l,g=(t-e)*u-(o-n)*l,u=d/c,l=g/c,h.x=e+u*(t-e),h.y=n+u*(o-n),u>0&&1>u&&(h.onLine1=!0),l>0&&1>l&&(h.onLine2=!0),h)}var n=function(n,t){var o,i=[{x1:t.x1,y1:t.y1,x2:t.x1,y2:t.y2},{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y1},{x1:t.x2,y1:t.y1,x2:t.x2,y2:t.y2},{x1:t.x1,y1:t.y2,x2:t.x2,y2:t.y2}];return _.each(i,function(t){if(!o){var i=e(n.x1,n.y1,n.x2,n.y2,t.x1,t.y1,t.x2,t.y2);i.onLine1&&i.onLine2&&(o=i)}}),o||(o={x:(t.x1+t.x2)/2,y:(t.y1+t.y2)/2}),o};return{getLineIntersectionWithRectangle:n}}),angular.module("sg.graphene").factory("sgSbml",function(){function e(e){var n,o=((e||{}).listOfSpecies||{}).species||{}||[],i=((e||{}).listOfReactions||{}).reaction||{}||[];o=t(o),n=_.map(o,function(e){return{id:e._id,name:e._name,classes:["species"],species:e}});var s;i=t(i),s=_.map(i,function(e){return{id:e._id,name:e._name,classes:["reaction"],reaction:e}});var r=[];return r.concat(n,s)}function n(e){var n,o=[],i=((e||{}).listOfReactions||{}).reaction||{}||[],s=function(e){var i={id:e._id,reactants:[],products:[],modifiers:[]},s=e.listOfReactants;s&&(n=t(s.speciesReference),_.each(n,function(n){o.push({source:n._species,target:e._id,reaction:e,rInfo:i,classes:["reaction","consumption"]}),i.reactants.push(n._species)}));var r=e.listOfProducts;r&&(n=t(r.speciesReference),_.each(n,function(n){o.push({source:e._id,target:n._species,reaction:e,rInfo:i,classes:["reaction","production"]}),i.products.push(n._species)}));var a=e.listOfModifiers;return a&&(n=t(a.modifierSpeciesReference),_.each(n,function(n){o.push({source:n._species,target:e._id,reaction:e,rInfo:i,classes:["modifier"]}),i.modifiers.push(n._species)})),i},r=t(i),a={};return _.each(r,function(e){var n=s(e);a[e._id]=n}),{edges:o,reactionInfo:a}}function t(e){return"object"==typeof e?e.length?e:[e]:"string"==typeof e?e.split():void 0}function o(e){var n={production:[],generation:[],reactant:[],degradation:[],modifier:[],source:[],sink:[]},t={};return _.each(e,function(e){var n=function(e){t[e]=t[e]||{asSource:[],asTarget:[]}};_.contains(e.classes,"modifier")||(n(e.source.id),n(e.target.id),t[e.source.id].asSource.push(e),t[e.target.id].asTarget.push(e))}),_.each(e,function(e){var o=e.source,i=e.target;if(_.contains(e.classes,"modifier"))n.modifier.push(e);else if(_.contains(e.classes,"sink"))n.sink.push(e);else if(_.contains(e.classes,"source"))n.source.push(e);else if(_.contains(o.classes,"reaction"))_.contains(i.classes,"species")&&(t[o.id].asTarget.length>0?(n.production.push(e),e.classes=_.union(e.classes,["production"])):(n.generation.push(e),e.classes=_.union(e.classes,["generation"])));else{if(!_.contains(o.classes,"species"))throw new Error("Could not classify link",e);_.contains(i.classes,"reaction")&&(t[i.id].asSource.length>0?(n.reactant.push(e),e.classes=_.union(e.classes,["reactant"])):(n.degradation.push(e),e.classes=_.union(e.classes,["degradation"])))}}),n}function i(e,n){var t=[],i=[],s=o(n);return _.each(s.generation,function(e){var n=e.source,o={id:"source-"+n.id,name:"Source",classes:["source"],reaction:n};t.push(o),e.rInfo.reactants.push(o.id),i.push({source:o,target:e.source,rInfo:e.rInfo,classes:["source"],reaction:e.reaction})}),_.each(s.degradation,function(e){var n=e.target,o={id:"sink-"+n.id,name:"Sink",classes:["sink"],reaction:n};t.push(o),e.rInfo.products.push(o.id),i.push({source:e.target,target:o,rInfo:e.rInfo,classes:["sink"],reaction:e.reaction})}),{nodes:t,edges:i}}var s=new X2JS;return{getSourceAndSinkNodes:function(e,n){return i(e,n)},getNodes:function(n){return e(n.model)},getEdges:function(e){return n(e.model)},classifyLinks:function(e){return o(e)},sbmlToJson:function(e){var n=s.xml_str2json(e);return n&&n.sbml&&n.sbml.model?n:!1}}});