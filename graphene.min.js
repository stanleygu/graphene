"use strict";angular.module("sg.graphene",[]).config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|blob):/)}]),angular.module("sg.graphene").controller("sgSbmlDataCtrl",["$scope","$http","$window","sgSbmlValidator",function(e,t,n,o){function r(){e.reactionInfo={},e.nodes=i(e.ngModel.sbml.model),e.edges=s(e.ngModel.sbml.model),e.species=_.filter(e.nodes,function(e){return _.contains(e.classes,"species")}),e.reactions=_.filter(e.nodes,function(e){return _.contains(e.classes,"reaction")});var t={};angular.forEach(e.nodes,function(n){t[n.id]=n,_.contains(n.classes,"reaction")?(n.width=0,n.height=0):(n.width=e.nodeSize.width,n.height=e.nodeSize.height)}),e.links=_.map(e.edges,function(e){return{source:t[e.source],target:t[e.target],reaction:e.reaction,rInfo:e.rInfo,classes:e.classes}});var o=d3.layout.force().charge(e.charge||-700).linkDistance(e.linkDistance||40).gravity(e.gravity||.1).size([e.width||800,e.height||800]);_.each(e.nodes,function(e){e.force=o});var r=!1;return o.nodes(e.nodes).links(e.links).on("tick",function(){e.height&&e.width&&(_.each(e.nodes,function(t){t.x=Math.max(t.width,Math.min(e.width-t.width,t.x)),t.y=Math.max(t.height,Math.min(e.height-t.height,t.y))}),r||(e.$digest(),r=!0));var t=e.layoutStopThreshold||.01;o.alpha()<=t&&(o.stop(),e.$digest(),e.layoutComplete&&_.isFunction(n[e.layoutComplete])&&n[e.layoutComplete]()),e.$digest()}).start(),e.exports={links:e.links,nodes:e.nodes,force:o},o}function i(e){var t,n=((e||{}).listOfSpecies||{}).species||{}||[],o=((e||{}).listOfReactions||{}).reaction||{}||[];n=a(n),t=_.map(n,function(e){return{id:e._id,name:e._name,classes:["species"],species:e}});var r;return o=a(o),r=_.map(o,function(e){return{id:e._id,name:e._name,classes:["reaction"],reaction:e}}),t.concat(r)}function s(t){var n=[];e.reactionInfo={};var o,r=((t||{}).listOfReactions||{}).reaction||{}||[],i=function(e){var t={id:e._id,reactants:[],products:[],modifiers:[]},r=e.listOfReactants;r&&(o=a(r.speciesReference),_.each(o,function(o){n.push({source:o._species,target:e._id,reaction:e,rInfo:t,classes:["reaction","consumption"]}),t.reactants.push(o._species)}));var i=e.listOfProducts;i&&(o=a(i.speciesReference),_.each(o,function(o){n.push({source:e._id,target:o._species,reaction:e,rInfo:t,classes:["reaction","production"]}),t.products.push(o._species)}));var s=e.listOfModifiers;return s&&(o=a(s.modifierSpeciesReference),_.each(o,function(o){n.push({source:o._species,target:e._id,reaction:e,rInfo:t,classes:["modifier"]}),t.modifiers.push(o._species)})),t},s=a(r);return _.each(s,function(t){var n=i(t);e.reactionInfo[t._id]=n}),n}function a(e){return"object"==typeof e?e.length?e:[e]:"string"==typeof e?e.split():void 0}e.exports={},e.sbmlUrl&&t.get(e.sbmlUrl).success(function(t){var n=o.process(t);n&&(e.ngModel=n,e.force=r())}),e.$watch("sbml",function(t){if(t){var n=o.process(t);n&&(e.ngModel=n,e.force=r())}})}]),angular.module("sg.graphene").controller("sgSbmlLayoutCtrl",["$scope",function(e){function t(e,t,n,o,r,i,s,a){var c,u,l,g,d,p={x:null,y:null,onLine1:!1,onLine2:!1};return c=(a-i)*(n-e)-(s-r)*(o-t),0===c?p:(u=t-i,l=e-r,g=(s-r)*u-(a-i)*l,d=(n-e)*u-(o-t)*l,u=g/c,l=d/c,p.x=e+u*(n-e),p.y=t+u*(o-t),u>0&&1>u&&(p.onLine1=!0),l>0&&1>l&&(p.onLine2=!0),p)}var n;e.classifyLinks=function(e){var t={production:[],generation:[],reactant:[],degradation:[],modifier:[]},n={};return _.each(e,function(e){var t=function(e){n[e]=n[e]||{asSource:[],asTarget:[]}};t(e.source.id),t(e.target.id),n[e.source.id].asSource.push(e),n[e.target.id].asTarget.push(e)}),_.each(e,function(e){var o=e.source,r=e.target;_.contains(e.classes,"modifier")?t.modifier.push(e):_.contains(o.classes,"reaction")?_.contains(r.classes,"species")&&(n[o.id].asTarget.length>0?(t.production.push(e),e.classes=_.union(e.classes,["production"])):(t.generation.push(e),e.classes=_.union(e.classes,["generation"]))):_.contains(o.classes,"species")&&_.contains(r.classes,"reaction")&&(n[r.id].asSource.length>0?(t.reactant.push(e),e.classes=_.union(e.classes,["reactant"])):(t.degradation.push(e),e.classes=_.union(e.classes,["degradation"])))}),t};var o=function(e,t){var n={};return angular.forEach(e,function(e){n[e[t||"id"]]=e}),n};e.textVisibilityLookup={species:!0,reaction:!1},e.lookupMarkerId=function(e){return _.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionProduction":_.every(e,function(e){return _.contains(["reaction","production"],e)})?"reactionConsumption":void 0},e.sizeLookup={species:30,reaction:5};var r=function(e){var t=e.rInfo;return n[t.id]},i=function(e){var t=e.rInfo,o=r(e),i=_.union(t.products,t.reactants);if(i.length<=1)return o;var s=0,a=0;return angular.forEach(i,function(e){var t=n[e];s+=t.x,a+=t.y}),{x:s/i.length,y:a/i.length}},s=function(e,n){var o,r=[{x1:n.x1,y1:n.y1,x2:n.x1,y2:n.y2},{x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y1},{x1:n.x2,y1:n.y1,x2:n.x2,y2:n.y2},{x1:n.x1,y1:n.y2,x2:n.x2,y2:n.y2}];return _.each(r,function(n){if(!o){var r=t(e.x1,e.y1,e.x2,e.y2,n.x1,n.y1,n.x2,n.y2);r.onLine1&&r.onLine2&&(o=r)}}),o||(o={x:(n.x1+n.x2)/2,y:(n.y1+n.y2)/2}),o};e.extendPoint=function(e,t,n){var o=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));return{x:t.x+(t.x-e.x)/o*n,y:t.y+(t.y-e.y)/o*n}},e.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type});var a=function(e){var t=i(e),n=r(e);n.x=t.x,n.y=t.y;var o,a;o=_.isEqual(e.source.width,0)?0:18,a=_.isEqual(e.target.width,0)?0:18;var c=s({x1:e.target.x,y1:e.target.y,x2:e.source.x,y2:e.source.y},{x1:e.source.x-(e.source.width/2+o),y1:e.source.y-(e.source.height/2+o),x2:e.source.x+(e.source.width/2+o),y2:e.source.y+(e.source.height/2+o)}),u=s({x1:e.source.x,y1:e.source.y,x2:e.target.x,y2:e.target.y},{x1:e.target.x-(e.target.width/2+a),y1:e.target.y-(e.target.height/2+a),x2:e.target.x+(e.target.width/2+a),y2:e.target.y+(e.target.height/2+a)});e.x1=c.x,e.y1=c.y,e.x2=u.x,e.y2=u.y},c=[],u=[];e.$watchCollection("imports.links",function(t){t&&(_.each(c,function(e){e()}),c=[],e.links=e.imports.links,e.lines=e.classifyLinks(e.links),n=o(e.imports.nodes),_.each(e.links,function(t){var n=e.$watch(function(){return t.source.x+t.source.y+t.target.x+t.target.y},function(){a(t)});a(t),c.push(n)}))}),e.$watchCollection("imports.nodes",function(t){t&&(_.each(u,function(e){e()}),u=[],e.nodes=e.imports.nodes,n=o(e.nodes),e.species=_.filter(e.nodes,function(e){return _.contains(e.classes,"species")}),e.reactions=_.filter(e.nodes,function(e){return _.contains(e.classes,"reaction")}))})}]),angular.module("sg.graphene").controller("sgTidalDataCtrl",["$scope","$http","$window",function(e,t,n){e.callWindowFunction=function(e){_.isFunction(n[e])&&n[e]()},e.$watch("jsonUrl",function(o){o&&t.get(e.jsonUrl).success(function(t){e.data=t,n.copy=angular.copy(t)})}),e.$watch("json",function(t){t&&(e.data=e.json)});var o=function(e){var t=new Blob([e],{type:"text/plain"});return(window.URL||window.webkitURL).createObjectURL(t)};e.svgToUrl=function(){var t=n.document.querySelector("svg"),r=new XMLSerializer;e.svgUrl=o(r.serializeToString(t))},e.$watch("data",function(t){if(t){var n=t;e.edges=_.map(n.edges,function(e){return{source:_.find(n.nodes,function(t){return t.id===e.nodes[0]}),target:_.find(n.nodes,function(t){return t.id===e.nodes[1]}),type:e.type}});var o=n.timeSlots,r=_.keys(o).sort(function(e,t){var n=/[^a-zA-Z]/g,o=/[^0-9]/g,r=e.replace(n,""),i=t.replace(n,"");if(r===i){var s=parseInt(e.replace(o,""),10),a=parseInt(t.replace(o,""),10);return s===a?0:s>a?1:-1}return r>i?1:-1}),i={};i.max=_.max(n.nodes,function(e){return e.size}),i.min=_.min(n.nodes,function(e){return e.size}),e.groups=[];var s=0;_.each(r,function(t){var r=o[t],a=_.filter(n.nodes,function(e){return _.contains(r,e.id)});_.each(a,function(t){t.group=s,t.scaleFactor=(t.size-i.min.size)/(i.max.size-i.min.size),t.width=e.nodeSize.min.width+(e.nodeSize.max.width-e.nodeSize.min.width)*t.scaleFactor,t.height=e.nodeSize.min.height+(e.nodeSize.max.height-e.nodeSize.min.height)*t.scaleFactor});var c=_.filter(e.edges,function(e){return _.contains(r,e.source.id)&&_.contains(r,e.target.id)}),u=d3.layout.force().charge(e.charge||-700).linkDistance(e.linkDistance||40).gravity(e.gravity||.1).size([e.subgraph.width||800,e.subgraph.height||800]);_.each(a,function(e){e.force=u});var l=!1;u.nodes(a).on("tick",function(){e.subgraph.height&&e.subgraph.width&&(_.each(a,function(t){t.x=Math.max(t.width,Math.min(e.subgraph.width-t.width,t.x)),t.y=Math.max(t.height,Math.min(e.subgraph.height-t.height,t.y))}),l||(e.$digest(),l=!0));var t=e.layoutStopThreshold||.01;u.alpha()<=t&&(u.stop(),e.$digest(),e.layoutComplete&&e.callWindowFunction(e.layoutComplete))}).start(),e.groups.push({nodes:a,links:c,name:t}),s+=1}),e.exports={groups:e.groups,edges:e.edges,subgraph:e.subgraph}}})}]),angular.module("sg.graphene").controller("sgTidalLayoutCtrl",["$scope",function(e){function t(e,t,n,o,r,i,s,a){var c,u,l,g,d,p={x:null,y:null,onLine1:!1,onLine2:!1};return c=(a-i)*(n-e)-(s-r)*(o-t),0===c?p:(u=t-i,l=e-r,g=(s-r)*u-(a-i)*l,d=(n-e)*u-(o-t)*l,u=g/c,l=d/c,p.x=e+u*(n-e),p.y=t+u*(o-t),u>0&&1>u&&(p.onLine1=!0),l>0&&1>l&&(p.onLine2=!0),p)}e.spacer=10;var n=function(e,n){var o,r=[{x1:n.x1,y1:n.y1,x2:n.x1,y2:n.y2},{x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y1},{x1:n.x2,y1:n.y1,x2:n.x2,y2:n.y2},{x1:n.x1,y1:n.y2,x2:n.x2,y2:n.y2}];return _.each(r,function(n){if(!o){var r=t(e.x1,e.y1,e.x2,e.y2,n.x1,n.y1,n.x2,n.y2);r.onLine1&&r.onLine2&&(o=r)}}),o||(o={x:(n.x1+n.x2)/2,y:(n.y1+n.y2)/2}),o},o=function(t){var o=n({x1:t.source.x,y1:t.source.y+t.source.group*e.imports.subgraph.height,x2:t.target.x,y2:t.target.y+t.target.group*e.imports.subgraph.height},{x1:t.source.x-(t.source.width/2+e.spacer),y1:t.source.y-(t.source.height/2+e.spacer)+t.source.group*e.imports.subgraph.height,x2:t.source.x+t.source.width/2+e.spacer,y2:t.source.y+t.source.height/2+e.spacer+t.source.group*e.imports.subgraph.height}),r=n({x1:t.source.x,y1:t.source.y+t.source.group*e.imports.subgraph.height,x2:t.target.x,y2:t.target.y+t.target.group*e.imports.subgraph.height},{x1:t.target.x-(t.target.width/2+e.spacer),y1:t.target.y-(t.target.height/2+e.spacer)+t.target.group*e.imports.subgraph.height,x2:t.target.x+t.target.width/2+e.spacer,y2:t.target.y+t.target.height/2+e.spacer+t.target.group*e.imports.subgraph.height});t.x1=o.x,t.y1=o.y,t.x2=r.x,t.y2=r.y};e.$watchCollection("imports.edges",function(t){t&&(e.links=e.imports.edges,_.each(e.links,function(t){e.$watch(function(){return t.source.x+t.source.y+t.target.x+t.target.y},function(){o(t)}),o(t)}))}),e.arrow=d3.svg.symbol().size(function(e){return e.size}).type(function(e){return e.type}),e.OPACITY={focused:1,unfocused:.1,normal:.6},e.mouseoverNode=function(t){t.opacity=e.OPACITY.focused,_.each(e.imports.groups,function(n){_.each(n.nodes,function(n){n.id!==t.id&&(n.opacity=e.OPACITY.unfocused)})}),_.each(e.imports.edges,function(n){n.source.id!==t.id&&n.target.id!==t.id?n.opacity=e.OPACITY.unfocused:(n.opacity=e.OPACITY.focused,n.target.opacity=e.OPACITY.focused,n.source.opacity=e.OPACITY.focused)})},e.mouseleaveNode=function(){_.each(e.imports.groups,function(e){_.each(e.nodes,function(e){e.opacity=1})}),_.each(e.imports.edges,function(t){t.opacity=e.OPACITY.normal})}}]),angular.module("sg.graphene").directive("sgGraphene",["$http","$templateCache","$compile",function(e,t,n){return{restrict:"E",scope:{template:"@",imports:"=?"},link:function(o,r){function i(i){e.get(i,{cache:t}).success(function(e){r.children().remove(),r.append(n(e)(o)),a()})}function s(){o.scale=d3.event.scale,o.translate.x=d3.event.translate[0],o.translate.y=d3.event.translate[1],o.$digest()}function a(){o.svg=r}i(o.template),o.translate={},o.scale=1;var c=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([.5,8]).on("zoom",s);o.$watch("enable-zoom",function(e){e&&d3.select(r.find("svg")[0]).call(c)})}}}]).directive("caseSensitive",["$timeout",function(e){return{link:function(t,n,o){e(function(){t.attr=o;var e=o.caseSensitive.split(",");angular.forEach(e,function(e){var o=e.toLowerCase();t.$watch("attr[lowercase]",function(){n[0].setAttribute(e,n[0].getAttribute(o))})})},0)}}}]).directive("draggable",["$document",function(e){return{link:function(t,n){function o(e){var o=n.scope().node;o.px=e.pageX/t.scale+i.x,o.py=e.pageY/t.scale+i.y,n.scope().$apply(),t.onDrag&&t.onDrag(e,o),t.imports&&t.imports.force&&t.imports.force.resume()}function r(){var t=n.scope().node;delete t.fixed,e.unbind("mousemove",o),e.unbind("mouseup",r)}var i={};n.css({position:"relative",border:"1px solid red",backgroundColor:"lightgrey",cursor:"pointer"}),n.on("mousedown",function(s){s.preventDefault(),s.stopPropagation();var a=n.scope().node;a.fixed=!0,i.x=a.x-s.pageX/t.scale,i.y=a.y-s.pageY/t.scale,e.on("mousemove",o),e.on("mouseup",r)})}}}]),angular.module("sg.graphene").factory("sgSbmlValidator",function(){var e=new X2JS;return{process:function(t){var n=e.xml_str2json(t);return n&&n.sbml&&n.sbml.model?n:!1}}});